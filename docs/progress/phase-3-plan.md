# Phase 3 开发计划：权限完善与质量提升

**创建时间**: 2026-01-18
**阶段目标**: 完善权限控制，提升测试覆盖率，优化用户体验
**预计周期**: 3-4 周

---

## 阶段概述

Phase 2 已完成全部 158+ 个 API 端点开发、前后端对接、测试框架搭建和系统优化。Phase 3 的核心目标是**提升系统质量和安全性**——完善 RBAC 权限控制、增加集成测试、优化前端表单体验。

---

## 任务分解

### Sprint 9: RBAC 权限完善（P0）✅ 已完成

**目标**: 细化角色权限控制，确保数据安全
**完成时间**: 2026-01-18
**完成报告**: [/docs/reports/completed/sprint-9-rbac-completion.md](../reports/completed/sprint-9-rbac-completion.md)

#### 9.1 权限守卫开发
| 任务 | 说明 | 状态 |
|------|------|------|
| 创建 RolesGuard | 基于角色的访问控制 | ✅ |
| 创建 PermissionsGuard | 基于权限的细粒度控制 | ⏭️ 推迟 |
| 创建权限装饰器 | @Roles(), @Permissions() | ✅ |

#### 9.2 权限配置
| 端点分类 | 允许角色 | 状态 |
|----------|----------|------|
| 用户管理 | ADMIN | ✅ |
| 机队管理 | ADMIN, MANAGER | ✅ |
| 飞机管理 | ADMIN, MANAGER | ✅ |
| 飞行记录 | ALL (读取), PILOT (写入) | ✅ |
| 工单管理 | MECHANIC, INSPECTOR, MANAGER | ✅ |
| 库存管理 | MECHANIC, MANAGER | ✅ |
| 采购管理 | MANAGER | ✅ |
| 维保计划 | MANAGER, INSPECTOR | ✅ |

#### 9.3 权限测试
| 测试场景 | 说明 | 状态 |
|----------|------|------|
| 角色隔离测试 | 验证不同角色的访问权限 | ✅ |
| 权限越权测试 | 验证权限边界 | ✅ |

---

### Sprint 10: 集成测试（P0）✅ 已完成

**目标**: 验证核心业务流程完整性
**完成时间**: 2026-01-18
**完成报告**: [/docs/reports/completed/sprint-10-e2e-testing-completion.md](../reports/completed/sprint-10-e2e-testing-completion.md)

#### 10.1 认证流程 E2E
| 测试用例 | 说明 | 状态 |
|----------|------|------|
| 用户注册 | 注册 → 登录 → 获取个人信息 | ✅ |
| 登录流程 | 正常登录 → Token 验证 → 刷新 | ✅ |
| 密码修改 | 修改密码 → 旧密码失效 | ⏭️ 推迟 |
| 权限验证 | 无权限访问 → 401/403 | ✅ |

#### 10.2 工单完整流程 E2E
| 测试用例 | 说明 | 状态 |
|----------|------|------|
| 创建工单 | 创建 → 分配 → 开始 | ✅ |
| 执行工单 | 添加任务 → 完成任务 → 提交 | ✅ |
| 检验放行 | RII 签字 → 检验 → 放行 | ✅ |
| 取消工单 | 取消 → 状态回滚 | ✅ |

#### 10.3 零部件流转 E2E
| 测试用例 | 说明 | 状态 |
|----------|------|------|
| 安装零部件 | 零部件装机 → 更新飞机 BOM | ✅ |
| 拆卸零部件 | 拆下 → 入库 → 履历保留 | ✅ |
| 转移零部件 | A飞机拆下 → 安装到B飞机 | ✅ |
| 报废零部件 | 拆下 → 报废 → 履历归档 | ✅ |

---

### Sprint 11: Controller 层测试（P1）

**目标**: 提升 API 测试覆盖率

#### 11.1 HTTP 请求测试
| 模块 | 控制器 | 状态 |
|------|--------|------|
| Auth | AuthController | ⏳ |
| User | UserController | ⏳ |
| Asset | FleetController, AircraftController, ComponentController | ⏳ |
| Flight | FlightLogController, PilotReportController | ⏳ |
| Maintenance | WorkOrderController, MaintenanceSchedulerController | ⏳ |
| Inventory | InventoryController, WarehouseController, MovementController | ⏳ |

#### 11.2 测试内容
- 请求参数验证
- 响应格式验证
- 错误码验证
- 权限验证

---

### Sprint 12: 前端表单完善（P1）

**目标**: 完善创建/编辑页面 API 对接

#### 12.1 表单页面对接
| 页面 | 类型 | 状态 |
|------|------|------|
| aircraft-form-page | 创建/编辑 | ⏳ |
| component-form-page | 创建/编辑 | ⏳ |
| work-order-form-page | 创建/编辑 | ⏳ |
| flight-log-form-page | 创建/编辑 | ⏳ |
| pirep-form-page | 创建 | ⏳ |
| inventory-form-page | 创建/编辑 | ⏳ |

#### 12.2 表单增强
| 功能 | 说明 | 状态 |
|------|------|------|
| 表单验证 | Zod schema 前端验证 | ⏳ |
| 错误提示 | 字段级错误提示 | ⏳ |
| 加载状态 | 提交按钮 loading | ⏳ |
| 成功反馈 | Toast 提示 + 跳转 | ⏳ |

---

### Sprint 13: PWA + 离线支持（P2）

**目标**: 支持野外离线作业场景

#### 13.1 Service Worker
| 功能 | 说明 | 状态 |
|------|------|------|
| 静态资源缓存 | HTML/CSS/JS | ⏳ |
| API 响应缓存 | 列表数据 | ⏳ |
| 离线指示器 | 网络状态显示 | ⏳ |

#### 13.2 离线数据
| 功能 | 说明 | 状态 |
|------|------|------|
| IndexedDB 存储 | 本地数据持久化 | ⏳ |
| 离线表单提交 | 队列 + 后台同步 | ⏳ |
| 冲突解决 | 时间戳 + 版本号 | ⏳ |

---

### Sprint 14: 性能优化（P2）

**目标**: 提升系统响应速度

#### 14.1 后端优化
| 任务 | 说明 | 状态 |
|------|------|------|
| 查询优化 | 减少 N+1 查询 | ⏳ |
| 索引优化 | 分析慢查询 | ⏳ |
| Redis 缓存 | 热点数据缓存 | ⏳ |

#### 14.2 前端优化
| 任务 | 说明 | 状态 |
|------|------|------|
| 代码分割 | 路由级 lazy loading | ⏳ |
| 虚拟列表 | 大数据列表优化 | ⏳ |
| 图片优化 | 懒加载 + WebP | ⏳ |

---

## 里程碑与验收

### M1: 权限完善（Sprint 9 完成）✅
- [x] RolesGuard 实现
- [x] 所有端点配置权限
- [x] 权限测试通过

### M2: 测试达标（Sprint 10-11 完成）
- [x] E2E 测试覆盖核心流程 (60 个测试，Sprint 10 完成)
- [ ] Controller 测试覆盖率 > 70%
- [ ] 无 P0 级别 Bug

### M3: 前端完善（Sprint 12 完成）
- [ ] 所有表单页面 API 对接
- [ ] 表单验证完善
- [ ] 用户体验优化

### M4: 生产就绪（Sprint 13-14 完成）
- [ ] PWA 支持
- [ ] 性能达标
- [ ] 文档完善

---

## 预计工作量

| Sprint | 内容 | 预计天数 |
|--------|------|----------|
| Sprint 9 | RBAC 权限完善 | 5 天 |
| Sprint 10 | 集成测试 | 4 天 |
| Sprint 11 | Controller 层测试 | 3 天 |
| Sprint 12 | 前端表单完善 | 5 天 |
| Sprint 13 | PWA + 离线支持 | 5 天 |
| Sprint 14 | 性能优化 | 3 天 |
| **总计** | | **25 天** |

---

## 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 权限设计复杂 | 开发延期 | 先实现基础 RBAC，逐步细化 |
| E2E 测试不稳定 | 测试维护成本高 | 关注核心路径，减少边缘用例 |
| 离线同步冲突 | 数据不一致 | 明确冲突解决策略，以服务端为准 |

---

## 优先级说明

- **P0（必须完成）**: Sprint 9-10，确保系统安全和核心质量
- **P1（应该完成）**: Sprint 11-12，提升开发效率和用户体验
- **P2（可以完成）**: Sprint 13-14，面向生产环境的高级特性
