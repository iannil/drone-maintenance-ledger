# Phase 2 开发计划：系统集成与功能完善

**创建时间**: 2026-01-16
**阶段目标**: 完成前后端集成，实现系统可用

---

## 阶段概述

Phase 1 已完成前端框架（51 个页面）和核心 API（89 个端点）的开发。Phase 2 的核心目标是**让系统真正可用**——执行数据库迁移、完成前后端对接、补充缺失的 API。

---

## 任务分解

### Sprint 1: 基础设施就绪（P0）

**目标**: 数据库可用，系统可启动

#### 1.1 数据库迁移执行
| 任务 | 命令/操作 | 验收标准 |
|------|-----------|----------|
| 安装 PostgreSQL | `brew install postgresql@16` 或 Docker | 数据库服务运行中 |
| 创建数据库 | `CREATE DATABASE drone_ledger` | 数据库存在 |
| 配置环境变量 | 编辑 `.env` 文件 | `DATABASE_URL` 配置正确 |
| 推送 Schema | `pnpm --filter @repo/db db:push` | 15 张表创建成功 |
| 初始化种子数据 | `pnpm --filter @repo/db db:seed` | 测试用户和演示数据存在 |
| 验证数据库 | `pnpm --filter @repo/db db:studio` | Drizzle Studio 可访问 |

**预计工作量**: 0.5 天

#### 1.2 后端服务启动验证
| 任务 | 验收标准 |
|------|----------|
| 安装依赖 | `pnpm install` 成功 |
| 启动 API 服务 | `pnpm --filter api dev` 成功启动 |
| 测试认证 API | POST `/auth/login` 返回 JWT |
| 测试资产 API | GET `/fleets` 返回数据 |

**预计工作量**: 0.5 天

---

### Sprint 2: 前后端对接（P0）

**目标**: 前端页面使用真实 API 数据

#### 2.1 API 客户端完善
| 任务 | 文件 | 说明 |
|------|------|------|
| 配置 API 基础 URL | `apps/web/src/services/api.ts` | 环境变量配置 |
| 完善请求拦截器 | `apps/web/src/services/api.ts` | JWT Token 自动附加 |
| 完善响应拦截器 | `apps/web/src/services/api.ts` | 401 自动跳转登录 |
| 统一错误处理 | `apps/web/src/services/api.ts` | Toast 提示 |

**预计工作量**: 1 天

#### 2.2 核心页面 API 对接（按优先级）

##### 第一批：认证与首页
| 页面 | 对接 API | 工作量 |
|------|----------|--------|
| 登录页 | `POST /auth/login` | 0.5 天 |
| 仪表板 | 统计 API（待开发） | 1 天 |

##### 第二批：资产配置
| 页面 | 对接 API | 工作量 |
|------|----------|--------|
| 机队列表 | `GET /fleets` | 0.5 天 |
| 机队详情 | `GET /fleets/:id` | 0.5 天 |
| 飞机列表 | `GET /aircraft` | 0.5 天 |
| 飞机详情 | `GET /aircraft/:id` | 0.5 天 |
| 飞机表单 | `POST/PUT /aircraft` | 0.5 天 |
| 零部件列表 | `GET /components` | 0.5 天 |
| 零部件详情 | `GET /components/:id` | 0.5 天 |
| 零部件表单 | `POST/PUT /components` | 0.5 天 |

##### 第三批：飞行记录
| 页面 | 对接 API | 工作量 |
|------|----------|--------|
| 飞行记录列表 | `GET /flight-logs` | 0.5 天 |
| 飞行记录详情 | `GET /flight-logs/:id` | 0.5 天 |
| 飞行记录表单 | `POST/PUT /flight-logs` | 0.5 天 |
| PIREP 列表 | `GET /pilot-reports` | 0.5 天 |
| PIREP 表单 | `POST /pilot-reports` | 0.5 天 |

##### 第四批：工单管理
| 页面 | 对接 API | 工作量 |
|------|----------|--------|
| 工单列表 | `GET /work-orders` | 0.5 天 |
| 工单详情 | `GET /work-orders/:id` | 0.5 天 |
| 工单表单 | `POST/PUT /work-orders` | 0.5 天 |
| 工单执行 | `POST /work-orders/:id/start` 等 | 1 天 |
| 工单放行 | `POST /work-orders/:id/release` | 0.5 天 |

**预计总工作量**: 10 天

---

### Sprint 3: 缺失 API 开发（P1）

**目标**: 补充前端页面所需但尚未实现的 API

#### 3.1 库存管理 API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/inventory` | GET | 库存列表（支持分页、筛选） |
| `/inventory/:id` | GET | 库存详情 |
| `/inventory/movements` | GET | 库存移动记录 |
| `/inventory/movements` | POST | 创建库存移动（入库/出库/调拨） |
| `/inventory/alerts` | GET | 库存预警列表 |
| `/inventory/withdraw` | POST | 领料 |
| `/inventory/return` | POST | 退料 |

**预计工作量**: 3 天

#### 3.2 仓库管理 API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/warehouses` | GET | 仓库列表 |
| `/warehouses/:id` | GET | 仓库详情 |
| `/warehouses` | POST | 创建仓库 |
| `/warehouses/:id` | PUT | 更新仓库 |
| `/warehouses/:id` | DELETE | 删除仓库 |

**预计工作量**: 1 天

#### 3.3 采购管理 API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/suppliers` | CRUD | 供应商管理 |
| `/purchase-orders` | CRUD | 采购订单管理 |
| `/purchase-requests` | CRUD | 采购申请管理 |

**预计工作量**: 3 天

#### 3.4 统计分析 API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/stats/dashboard` | GET | 仪表板统计数据 |
| `/stats/fleet-status` | GET | 机队状态统计 |
| `/stats/flight-hours` | GET | 飞行小时统计 |
| `/stats/maintenance` | GET | 维保统计 |
| `/stats/reliability` | GET | 可靠性分析数据 |

**预计工作量**: 2 天

---

### Sprint 4: 维保调度引擎（P1）

**目标**: 实现自动维保提醒和工单生成

#### 4.1 触发器计算服务
| 功能 | 说明 |
|------|------|
| 日历触发器 | 基于日期计算下次维保时间 |
| 飞行小时触发器 | 基于累计飞行小时计算 |
| 起降循环触发器 | 基于循环次数计算 |
| 电池循环触发器 | 基于充放电次数计算 |
| 寿命件触发器 | 计算剩余寿命 |

#### 4.2 调度服务
| 功能 | 说明 |
|------|------|
| 维保到期检查 | 定时任务，检查即将到期的维保 |
| 预警生成 | 提前 N 天生成预警 |
| 自动工单生成 | 到期自动创建工单 |
| 通知推送 | 邮件/站内信通知 |

**预计工作量**: 5 天

---

### Sprint 5: 测试与质量（P0）

**目标**: 保证代码质量

#### 5.1 单元测试
| 模块 | 测试内容 | 工作量 |
|------|----------|--------|
| Repository 层 | 数据访问逻辑 | 2 天 |
| Service 层 | 业务逻辑 | 2 天 |
| Controller 层 | API 端点 | 1 天 |

#### 5.2 集成测试
| 测试场景 | 说明 | 工作量 |
|----------|------|--------|
| 认证流程 | 注册→登录→访问受保护资源 | 0.5 天 |
| 工单流程 | 创建→分配→执行→完成→放行 | 1 天 |
| 零部件流转 | 装机→飞行→拆下→安装到另一飞机 | 1 天 |

**预计总工作量**: 7.5 天

---

## 里程碑与验收

### M1: 系统可启动（Sprint 1 完成）
- [ ] 数据库迁移成功
- [ ] 种子数据初始化
- [ ] API 服务启动正常
- [ ] 可通过 API 登录

### M2: 核心功能可用（Sprint 2 完成）
- [ ] 登录页对接真实 API
- [ ] 资产配置页面数据真实
- [ ] 飞行记录页面数据真实
- [ ] 工单页面数据真实

### M3: 功能完整（Sprint 3-4 完成）
- [ ] 库存管理功能可用
- [ ] 采购管理功能可用
- [ ] 仪表板统计数据真实
- [ ] 维保预警正常工作

### M4: 质量达标（Sprint 5 完成）
- [ ] 单元测试覆盖率 > 70%
- [ ] 集成测试通过
- [ ] 无 P0 级别 Bug

---

## 遗留问题处理

### 高优先级（本阶段解决）
| 问题 | 解决方案 | Sprint |
|------|----------|--------|
| 数据库迁移未执行 | 执行 db:push | Sprint 1 |
| 前端使用 Mock 数据 | API 对接 | Sprint 2 |
| 库存 API 缺失 | 开发库存模块 | Sprint 3 |
| 统计 API 缺失 | 开发统计模块 | Sprint 3 |

### 中优先级（下阶段解决）
| 问题 | 说明 |
|------|------|
| 错误处理不完善 | 统一错误码和提示 |
| 日志系统缺失 | 接入结构化日志 |
| API 文档缺失 | 接入 Swagger |

### 低优先级（后续迭代）
| 问题 | 说明 |
|------|------|
| 离线支持 | Service Worker |
| 性能优化 | 查询优化、缓存 |
| 移动端适配 | PWA |

---

## 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| API 接口不匹配 | 前后端对接延误 | 先定义接口契约，再开发 |
| 数据库迁移失败 | 无法启动系统 | 保留回滚脚本 |
| 测试用例不足 | 质量隐患 | 关键路径优先覆盖 |
| 维保引擎逻辑复杂 | 开发延期 | 简化首版，迭代完善 |

---

## 资源需求

### 开发环境
- PostgreSQL 16+
- Node.js 20+
- pnpm 9+

### 测试账号
| 角色 | 用户名 | 密码 |
|------|--------|------|
| 管理员 | admin | password123 |
| 经理 | manager | password123 |
| 飞手 | pilot | password123 |
| 维修工 | mechanic | password123 |
| 检验员 | inspector | password123 |

---

## 总工作量估算

| Sprint | 内容 | 工作量 |
|--------|------|--------|
| Sprint 1 | 基础设施就绪 | 1 天 |
| Sprint 2 | 前后端对接 | 11 天 |
| Sprint 3 | 缺失 API 开发 | 9 天 |
| Sprint 4 | 维保调度引擎 | 5 天 |
| Sprint 5 | 测试与质量 | 7.5 天 |
| **总计** | | **33.5 天** |

---

## 下一步行动

1. **立即执行**: Sprint 1 - 数据库迁移
2. **本周目标**: 完成登录页和首页的 API 对接
3. **短期目标**: 2 周内完成核心页面对接
