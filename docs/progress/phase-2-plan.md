# Phase 2 开发计划：系统集成与功能完善

**创建时间**: 2026-01-16
**更新时间**: 2026-01-17
**阶段目标**: 完成前后端集成，实现系统可用
**当前状态**: Sprint 2 已完成，Sprint 3 待开始

---

## 阶段概述

Phase 1 已完成前端框架（51 个页面）和核心 API（92 个端点）的开发。Phase 2 的核心目标是**让系统真正可用**——执行数据库迁移、完成前后端对接、补充缺失的 API。

---

## 任务分解

### Sprint 1: 基础设施就绪（P0）✅ 已完成

**目标**: 数据库可用，系统可启动
**完成时间**: 2026-01-16

#### 1.1 数据库迁移执行 ✅
| 任务 | 命令/操作 | 状态 |
|------|-----------|------|
| ~~安装 PostgreSQL~~ | 使用 SQLite 替代 | ✅ 已完成 |
| 创建数据库 | `database/local.db` | ✅ 已完成 |
| 配置环境变量 | 编辑 `.env` 文件 | ✅ 已完成 |
| 推送 Schema | `pnpm --filter @repo/db db:push` | ✅ 已完成 |
| 初始化种子数据 | `pnpm --filter @repo/db db:seed` | ✅ 已完成 |
| 验证数据库 | `pnpm --filter @repo/db db:studio` | ✅ 已完成 |

#### 1.2 后端服务启动验证 ✅
| 任务 | 状态 |
|------|------|
| 安装依赖 | ✅ 已完成 |
| 启动 API 服务 | ✅ 已完成 |
| 测试认证 API | ✅ 已完成 |
| 测试资产 API | ✅ 已完成 |

**完成报告**: [phase-2-sprint-1-infrastructure.md](../reports/completed/phase-2-sprint-1-infrastructure.md)

---

### Sprint 2: 前后端对接（P0）✅ 已完成

**目标**: 前端页面使用真实 API 数据
**完成时间**: 2026-01-17

**注意**: 存在约 56 个 TypeScript 编译错误，详见 [代码问题清单](../reports/code-issues-2026-01-17.md)

**完成报告**: [phase-2-sprint-2-api-integration.md](../reports/completed/phase-2-sprint-2-api-integration.md)

#### 2.1 API 客户端完善 ✅
| 任务 | 文件 | 状态 |
|------|------|------|
| 配置 API 基础 URL | `apps/web/src/services/api.ts` | ✅ |
| 完善请求拦截器 | `apps/web/src/services/api.ts` | ✅ |
| 完善响应拦截器 | `apps/web/src/services/api.ts` | ✅ |
| 统一错误处理 | `apps/web/src/services/api.ts` | ✅ |

#### 2.2 核心页面 API 对接 ✅

| 批次 | 页面 | 状态 |
|------|------|------|
| 第一批 | 登录页、仪表板 | ✅ |
| 第二批 | 机队/飞机/零部件 | ✅ |
| 第三批 | 飞行记录 | ✅ |
| 第四批 | 工单管理 | ✅ |

---

### Sprint 3: 缺失 API 开发（P1）⏳ 待开始

**目标**: 补充前端页面所需但尚未实现的 API

#### 3.1 库存管理 API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/inventory` | GET | 库存列表（支持分页、筛选） |
| `/inventory/:id` | GET | 库存详情 |
| `/inventory/movements` | GET | 库存移动记录 |
| `/inventory/movements` | POST | 创建库存移动（入库/出库/调拨） |
| `/inventory/alerts` | GET | 库存预警列表 |
| `/inventory/withdraw` | POST | 领料 |
| `/inventory/return` | POST | 退料 |

**预计工作量**: 3 天

#### 3.2 仓库管理 API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/warehouses` | GET | 仓库列表 |
| `/warehouses/:id` | GET | 仓库详情 |
| `/warehouses` | POST | 创建仓库 |
| `/warehouses/:id` | PUT | 更新仓库 |
| `/warehouses/:id` | DELETE | 删除仓库 |

**预计工作量**: 1 天

#### 3.3 采购管理 API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/suppliers` | CRUD | 供应商管理 |
| `/purchase-orders` | CRUD | 采购订单管理 |
| `/purchase-requests` | CRUD | 采购申请管理 |

**预计工作量**: 3 天

#### 3.4 统计分析 API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/stats/dashboard` | GET | 仪表板统计数据 |
| `/stats/fleet-status` | GET | 机队状态统计 |
| `/stats/flight-hours` | GET | 飞行小时统计 |
| `/stats/maintenance` | GET | 维保统计 |
| `/stats/reliability` | GET | 可靠性分析数据 |

**预计工作量**: 2 天

---

### Sprint 4: 维保调度引擎（P1）

**目标**: 实现自动维保提醒和工单生成

#### 4.1 触发器计算服务
| 功能 | 说明 |
|------|------|
| 日历触发器 | 基于日期计算下次维保时间 |
| 飞行小时触发器 | 基于累计飞行小时计算 |
| 起降循环触发器 | 基于循环次数计算 |
| 电池循环触发器 | 基于充放电次数计算 |
| 寿命件触发器 | 计算剩余寿命 |

#### 4.2 调度服务
| 功能 | 说明 |
|------|------|
| 维保到期检查 | 定时任务，检查即将到期的维保 |
| 预警生成 | 提前 N 天生成预警 |
| 自动工单生成 | 到期自动创建工单 |
| 通知推送 | 邮件/站内信通知 |

**预计工作量**: 5 天

---

### Sprint 5: 测试与质量（P0）

**目标**: 保证代码质量

#### 5.1 单元测试
| 模块 | 测试内容 | 工作量 |
|------|----------|--------|
| Repository 层 | 数据访问逻辑 | 2 天 |
| Service 层 | 业务逻辑 | 2 天 |
| Controller 层 | API 端点 | 1 天 |

#### 5.2 集成测试
| 测试场景 | 说明 | 工作量 |
|----------|------|--------|
| 认证流程 | 注册→登录→访问受保护资源 | 0.5 天 |
| 工单流程 | 创建→分配→执行→完成→放行 | 1 天 |
| 零部件流转 | 装机→飞行→拆下→安装到另一飞机 | 1 天 |

**预计总工作量**: 7.5 天

---

## 里程碑与验收

### M1: 系统可启动（Sprint 1 完成）✅ 已达成
- [x] 数据库迁移成功
- [x] 种子数据初始化
- [x] API 服务启动正常
- [x] 可通过 API 登录

### M2: 核心功能可用（Sprint 2 完成）✅ 已达成
- [x] 登录页对接真实 API
- [x] 资产配置页面数据真实
- [x] 飞行记录页面数据真实
- [x] 工单页面数据真实
- [ ] ⚠️ TypeScript 编译错误待修复（约 56 个）

### M3: 功能完整（Sprint 3-4 完成）⏳ 进行中
- [ ] 库存管理功能可用
- [ ] 采购管理功能可用
- [ ] 仪表板统计数据真实
- [ ] 维保预警正常工作

### M4: 质量达标（Sprint 5 完成）⏳ 待开始
- [ ] TypeScript 编译错误修复
- [ ] 单元测试覆盖率 > 70%
- [ ] 集成测试通过
- [ ] 无 P0 级别 Bug

---

## 遗留问题处理

### 高优先级（本阶段解决）
| 问题 | 解决方案 | 状态 |
|------|----------|------|
| 数据库迁移未执行 | 执行 db:push | ✅ 已完成 |
| 前端使用 Mock 数据 | API 对接 | ✅ 已完成 |
| **TypeScript 编译错误** | 修复约 56 个错误 | ⚠️ **待修复** |
| 库存 API 缺失 | 开发库存模块 | ⏳ Sprint 3 |
| 统计 API 缺失 | 开发统计模块 | ✅ 已完成 |

### 中优先级（下阶段解决）
| 问题 | 说明 |
|------|------|
| 错误处理不完善 | 统一错误码和提示 |
| 日志系统缺失 | 接入结构化日志 |
| API 文档缺失 | 接入 Swagger |

### 低优先级（后续迭代）
| 问题 | 说明 |
|------|------|
| 离线支持 | Service Worker |
| 性能优化 | 查询优化、缓存 |
| 移动端适配 | PWA |

---

## 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| API 接口不匹配 | 前后端对接延误 | 先定义接口契约，再开发 |
| 数据库迁移失败 | 无法启动系统 | 保留回滚脚本 |
| 测试用例不足 | 质量隐患 | 关键路径优先覆盖 |
| 维保引擎逻辑复杂 | 开发延期 | 简化首版，迭代完善 |

---

## 资源需求

### 开发环境
- PostgreSQL 16+
- Node.js 20+
- pnpm 9+

### 测试账号
| 角色 | 用户名 | 密码 |
|------|--------|------|
| 管理员 | admin | password123 |
| 经理 | manager | password123 |
| 飞手 | pilot | password123 |
| 维修工 | mechanic | password123 |
| 检验员 | inspector | password123 |

---

## 总工作量估算

| Sprint | 内容 | 工作量 |
|--------|------|--------|
| Sprint 1 | 基础设施就绪 | 1 天 |
| Sprint 2 | 前后端对接 | 11 天 |
| Sprint 3 | 缺失 API 开发 | 9 天 |
| Sprint 4 | 维保调度引擎 | 5 天 |
| Sprint 5 | 测试与质量 | 7.5 天 |
| **总计** | | **33.5 天** |

---

## 下一步行动

1. **立即执行**: 修复 TypeScript 编译错误（约 56 个）
2. **本周目标**: 开始 Sprint 3 - 库存管理 API 开发
3. **短期目标**: 完成所有缺失 API，实现功能完整
