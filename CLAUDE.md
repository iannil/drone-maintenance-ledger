# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在此代码库中工作时提供指导。

## 项目概述

DroneMaintenance-Ledger 是一个面向无人机和 eVTOL 飞行器的开源 MRO（维护、维修和运行）系统。它充当低空飞行器的"电子病历"系统，追踪零部件全生命周期、维保计划和适航合规状态。

当前状态： Phase 2 已完成，准备进入 Phase 3。项目已实现 158+ API 端点、51 个前端页面、21 个数据库表，908 个单元测试全部通过。

## 项目指南

- 目标：以强类型、可测试、分层解耦为核心，保证项目健壮性与可扩展性；以清晰可读、模式统一为核心，使大模型易于理解与改写。
- 适用范围：`apps/*`、`packages/*`、`database/*`、`scripts/*` 全部 TypeScript 源码与声明、测试与脚本、文档。
  注：当前使用`database`作为数据库工作区（workspace名称为`@repo/db`）。
- 语言约定：交流与文档使用中文；生成的代码使用英文；文档放在 `docs` 且使用 Markdown。
- 发布约定：
  - 发布固定在 `/release` 文件夹，如 rust 服务固定发布在 `/release/rust` 文件夹。
  - 发布的成果物必须且始终以生产环境为标准，要包含所有发布生产所应该包含的文件或数据（包含全量发布与增量发布，首次发布与非首次发布）。
- 文档约定：
  - 每次修改都必须延续上一次的进展，每次修改的进展都必须保存在对应的 `docs` 文件夹下的文档中。
  - 执行修改过程中，进展随时保存文档，带上实际修改的时间，便于追溯修改历史。
  - 未完成的修改，文档保存在 `/docs/progress` 文件夹下。
  - 已完成的修改，文档保存在 `/docs/reports/completed` 文件夹下。
  - 对修改进行验收，文档保存在 `/docs/reports` 文件夹下。
  - 对重复的、冗余的、不能体现实际情况的文档或文档内容，要保持更新和调整。
  - 文档模板和命名规范可以参考 `/docs/standards` 和 `docs/templates` 文件夹下的内容。

### 面向大模型的可改写性（LLM Friendly）

- 一致的分层与目录：相同功能在各应用/包中遵循相同结构与命名，使检索与大范围重构更可控。
- 明确边界与单一职责：函数/类保持单一职责；公共模块暴露极少稳定接口；避免隐式全局状态。
- 显式类型与契约优先：导出 API 均有显式类型；运行时与编译时契约一致（zod schema 即类型源）。
- 声明式配置：将重要行为转为数据驱动（配置对象 + `as const`/`satisfies`），减少分支与条件散落。
- 可搜索性：统一命名（如 `parseXxx`、`assertNever`、`safeJsonParse`、`createXxxService`），降低 LLM 与人类的检索成本。
- 小步提交与计划：通过 `IMPLEMENTATION_PLAN.md` 和小步提交让模型理解上下文、意图与边界。
- 变更安全策略：批量程序性改动前先将原文件备份至 `/backup` 相对路径；若错误数异常上升，立即回滚备份。

## 核心概念

### 零部件履历解耦

这是系统的核心架构原则：零部件履历跟随零部件，而不是随机身。 当序列号为 SN-12345 的电机从 A 飞机拆下并安装到 B 飞机时，其总飞行小时、维修记录和循环次数必须随之转移。这是航空业的行业标准实践。

### 六大核心中心架构

1. 资产配置中心 - 机队档案、BOM 树状结构、零部件全生命周期追踪
2. 计划与工程中心 - 维修大纲定义、多维度触发器（日历日、飞行小时、循环）、预测性预警
3. 飞行与技术记录本 - 电子飞行记录、故障报告(PIREP)、适航放行
4. 维修执行中心 - 工单管理、数字化工卡、带 RII（必检项）的检查单
5. 库存与供应链 - 多仓库库存管理、库存预警、零件适用性校验
6. 数据看板与报表 - 机队状态、适航履历、可靠性分析

### 维保触发器

系统支持多种维保计划触发类型：

- 日历日 - 例如：每 180 天
- 飞行小时 (FH) - 例如：每 50 小时
- 起降循环 (FC) - 例如：每 200 次起降
- 电池循环 - 例如：每 300 次充放电循环
- 寿命件 (LLP) - 绝对寿命上限（例如：桨叶 500 小时强制报废）

## 技术栈

| 层级 | 技术 | 版本 |
|------|------|------|
| Monorepo | Turborepo + pnpm | ^2.7 / ^9.15 |
| 后端 | NestJS | ^10.x |
| 前端 | React + MobX | ^19.x |
| UI 组件 | shadcn/ui + Tailwind CSS | ^3.x |
| ORM | Drizzle ORM | ^0.38.x |
| 数据库 | SQLite (开发) / PostgreSQL (生产) | - |
| 认证 | JWT + bcrypt | - |
| 校验 | Zod | ^3.x |
| 日志 | Winston | ^3.x |
| 安全 | Helmet + @nestjs/throttler | ^8.x / ^6.x |

## 关键设计考量

1. 离线优先架构 - 野外作业常处于低连接环境。移动端必须支持离线数据录入，恢复网络后自动同步。

2. 基于角色的访问控制 (RBAC) - 不同用户角色有不同权限：
   - 飞手：记录飞行、报告故障
   - 维修工：执行工单、领料
   - 检验员：审核工单、签字放行
   - 管理员：报表和配置的完整访问权限

3. 监管合规 - 电子技术记录本具有适航法律效力。数字签名和审计追踪至关重要。

4. 多租户 - 系统应同时支持私有化部署（面向企业机队运营方）和 SaaS 运营（面向小团队）。

## 开发命令

```bash
# 安装依赖
pnpm install

# 初始化数据库
pnpm db:push
pnpm --filter @repo/db db:seed

# 启动开发服务器
pnpm dev

# 运行测试
pnpm test

# 构建
pnpm build
```

### 服务地址

- Web 前端: http://localhost:3000
- API 服务: http://localhost:3001
- API 文档: http://localhost:3001/api/docs

### 测试账号

| 用户名 | 密码 | 角色 |
|--------|------|------|
| admin | password123 | 管理员 |
| pilot | password123 | 飞手 |
| mechanic | password123 | 维修工 |
| inspector | password123 | 检验员 |

## 文档

- 项目进展: `docs/PROJECT_STATUS.md`
- 部署指南: `docs/deployment.md`
- 开发规范: `docs/standards/`
- 完成报告: `docs/reports/completed/`
