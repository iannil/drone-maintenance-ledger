# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在此代码库中工作时提供指导。

## 项目概述

DroneMaintenance-Ledger 是一个面向无人机和 eVTOL 飞行器的开源 MRO（维护、维修和运行）系统。它充当低空飞行器的"电子病历"系统，追踪零部件全生命周期、维保计划和适航合规状态。

当前状态： 预实施规划阶段。项目目前仅有文档，尚未编写任何代码。

## 项目指南

- 目标：以强类型、可测试、分层解耦为核心，保证项目健壮性与可扩展性；以清晰可读、模式统一为核心，使大模型易于理解与改写。
- 适用范围：`apps/*`、`packages/*`、`database/*`、`scripts/*` 全部 TypeScript 源码与声明、测试与脚本、文档。
  注：当前使用`database`作为数据库工作区（workspace名称为`@repo/db`）。
- 语言约定：交流与文档使用中文；生成的代码使用英文；文档放在 `docs` 且使用 Markdown。
- 发布约定：
  - 发布固定在 `/release` 文件夹，如 rust 服务固定发布在 `/release/rust` 文件夹。
  - 发布的成果物必须且始终以生产环境为标准，要包含所有发布生产所应该包含的文件或数据（包含全量发布与增量发布，首次发布与非首次发布）。
- 文档约定：
  - 每次修改都必须延续上一次的进展，每次修改的进展都必须保存在对应的 `docs` 文件夹下的文档中。
  - 执行修改过程中，进展随时保存文档，带上实际修改的时间，便于追溯修改历史。
  - 未完成的修改，文档保存在 `/docs/progress` 文件夹下。
  - 已完成的修改，文档保存在 `/docs/reports/completed` 文件夹下。
  - 对修改进行验收，文档保存在 `/docs/reports` 文件夹下。
  - 对重复的、冗余的、不能体现实际情况的文档或文档内容，要保持更新和调整。
  - 文档模板和命名规范可以参考 `/docs/standards` 和 `docs/templates` 文件夹下的内容。

### 面向大模型的可改写性（LLM Friendly）

- 一致的分层与目录：相同功能在各应用/包中遵循相同结构与命名，使检索与大范围重构更可控。
- 明确边界与单一职责：函数/类保持单一职责；公共模块暴露极少稳定接口；避免隐式全局状态。
- 显式类型与契约优先：导出 API 均有显式类型；运行时与编译时契约一致（zod schema 即类型源）。
- 声明式配置：将重要行为转为数据驱动（配置对象 + `as const`/`satisfies`），减少分支与条件散落。
- 可搜索性：统一命名（如 `parseXxx`、`assertNever`、`safeJsonParse`、`createXxxService`），降低 LLM 与人类的检索成本。
- 小步提交与计划：通过 `IMPLEMENTATION_PLAN.md` 和小步提交让模型理解上下文、意图与边界。
- 变更安全策略：批量程序性改动前先将原文件备份至 `/backup` 相对路径；若错误数异常上升，立即回滚备份。

## 核心概念

### 零部件履历解耦

这是系统的核心架构原则：零部件履历跟随零部件，而不是随机身。 当序列号为 SN-12345 的电机从 A 飞机拆下并安装到 B 飞机时，其总飞行小时、维修记录和循环次数必须随之转移。这是航空业的行业标准实践。

### 六大核心中心架构

1. 资产配置中心 - 机队档案、BOM 树状结构、零部件全生命周期追踪
2. 计划与工程中心 - 维修大纲定义、多维度触发器（日历日、飞行小时、循环）、预测性预警
3. 飞行与技术记录本 - 电子飞行记录、故障报告(PIREP)、适航放行
4. 维修执行中心 - 工单管理、数字化工卡、带 RII（必检项）的检查单
5. 库存与供应链 - 多仓库库存管理、库存预警、零件适用性校验
6. 数据看板与报表 - 机队状态、适航履历、可靠性分析

### 维保触发器

系统支持多种维保计划触发类型：

- 日历日 - 例如：每 180 天
- 飞行小时 (FH) - 例如：每 50 小时
- 起降循环 (FC) - 例如：每 200 次起降
- 电池循环 - 例如：每 300 次充放电循环
- 寿命件 (LLP) - 绝对寿命上限（例如：桨叶 500 小时强制报废）

## 建议的技术栈

README 中建议以下技术栈（尚未实施）：

- 后端： Go (Golang) 或 Python (FastAPI/Django)
- 前端： React 或 Vue 3 + Ant Design/Element Plus
- 数据库： PostgreSQL（配合 PostGIS 支持地理空间功能）
- 移动端： Flutter 或 uni-app
- 可选： 区块链集成用于可验证记录（Hyperledger Fabric 或以太坊 Layer 2）

## 关键设计考量

1. 离线优先架构 - 野外作业常处于低连接环境。移动端必须支持离线数据录入，恢复网络后自动同步。

2. 基于角色的访问控制 (RBAC) - 不同用户角色有不同权限：
   - 飞手：记录飞行、报告故障
   - 维修工：执行工单、领料
   - 检验员：审核工单、签字放行
   - 管理员：报表和配置的完整访问权限

3. 监管合规 - 电子技术记录本具有适航法律效力。数字签名和审计追踪至关重要。

4. 多租户 - 系统应同时支持私有化部署（面向企业机队运营方）和 SaaS 运营（面向小团队）。

## 开发命令

暂无。 项目处于规划阶段，尚未设置构建系统、包管理器或依赖项。

## 文档

主要文档位于 `README.md`（中文）。包含详细的产品需求、技术架构方案、商业模式分析以及按模块划分的功能拆解。
